// marionette-threejs - v0.0.01
//
// https://github.com/Stonelinks/marionette-threejs
//
// Simple wrappers around three.js components using Backbone.Marionette
//
// Copyright (c)2014 - Lucas Doyle <lucas.p.doyle@gmail.com>
//
// Distributed under MIT license
//

!function(a,b){if("function"==typeof define&&define.amd)define(["backbone","exports"],function(c,d){a.m3js=b(a,d,c)});else if("undefined"!=typeof exports){var c=require("backbone");b(a,exports,c)}else a.m3js=b(a,{},a.Backbone)}(this,function(a,b,c){"use strict";THREE.OrbitControls=function(a,b){function c(){return 2*Math.PI/60/60*e.autoRotateSpeed}function d(){return Math.pow(.95,e.zoomSpeed)}this.object=a,this.domElement=void 0!==b?b:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var e=this,f=1e-6,g=new THREE.Vector2,h=new THREE.Vector2,i=new THREE.Vector2,j=new THREE.Vector2,k=new THREE.Vector2,l=new THREE.Vector2,m=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.Vector2,p=new THREE.Vector2,q=new THREE.Vector2,r=0,s=0,t=1,u=new THREE.Vector3,v=new THREE.Vector3,w=new THREE.Quaternion,x={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},y=x.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var z=(new THREE.Quaternion).setFromUnitVectors(a.up,new THREE.Vector3(0,1,0)),A=z.clone().inverse(),B={type:"change"},C={type:"start"},D={type:"end"};this.rotateLeft=function(a){void 0===a&&(a=c()),s-=a},this.rotateUp=function(a){void 0===a&&(a=c()),r-=a},this.panLeft=function(a){var b=this.object.matrix.elements;m.set(b[0],b[1],b[2]),m.multiplyScalar(-a),u.add(m)},this.panUp=function(a){var b=this.object.matrix.elements;m.set(b[4],b[5],b[6]),m.multiplyScalar(a),u.add(m)},this.pan=function(a,b){var c=e.domElement===document?e.domElement.body:e.domElement;if(void 0!==e.object.fov){var d=e.object.position,f=d.clone().sub(e.target),g=f.length();g*=Math.tan(e.object.fov/2*Math.PI/180),e.panLeft(2*a*g/c.clientHeight),e.panUp(2*b*g/c.clientHeight)}else void 0!==e.object.top?(e.panLeft(a*(e.object.right-e.object.left)/c.clientWidth),e.panUp(b*(e.object.top-e.object.bottom)/c.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(a){void 0===a&&(a=d()),t/=a},this.dollyOut=function(a){void 0===a&&(a=d()),t*=a},this.update=function(){var a=this.object.position;n.copy(a).sub(this.target),n.applyQuaternion(z);var b=Math.atan2(n.x,n.z),d=Math.atan2(Math.sqrt(n.x*n.x+n.z*n.z),n.y);this.autoRotate&&this.rotateLeft(c()),b+=s,d+=r,d=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,d)),d=Math.max(f,Math.min(Math.PI-f,d));var e=n.length()*t;e=Math.max(this.minDistance,Math.min(this.maxDistance,e)),this.target.add(u),n.x=e*Math.sin(d)*Math.sin(b),n.y=e*Math.cos(d),n.z=e*Math.sin(d)*Math.cos(b),n.applyQuaternion(A),a.copy(this.target).add(n),this.object.lookAt(this.target),s=0,r=0,t=1,u.set(0,0,0),(v.distanceToSquared(this.object.position)>f||8*(1-w.dot(this.object.quaternion))>f)&&(this.dispatchEvent(B),v.copy(this.object.position),w.copy(this.object.quaternion))},this.reset=function(){y=x.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.onMouseDown=function(a){if(e.enabled!==!1){if(a.preventDefault(),0===a.button){if(e.noRotate===!0)return;y=x.ROTATE,g.set(a.clientX,a.clientY)}else if(1===a.button){if(e.noZoom===!0)return;y=x.DOLLY,o.set(a.clientX,a.clientY)}else if(2===a.button){if(e.noPan===!0)return;y=x.PAN,j.set(a.clientX,a.clientY)}document.addEventListener("mousemove",e.onMouseMove,!1),document.addEventListener("mouseup",e.onMouseUp,!1),e.dispatchEvent(C)}},this.onMouseMove=function(a){if(e.enabled!==!1){a.preventDefault();var b=e.domElement===document?e.domElement.body:e.domElement;if(y===x.ROTATE){if(e.noRotate===!0)return;h.set(a.clientX,a.clientY),i.subVectors(h,g),e.rotateLeft(2*Math.PI*i.x/b.clientWidth*e.rotateSpeed),e.rotateUp(2*Math.PI*i.y/b.clientHeight*e.rotateSpeed),g.copy(h)}else if(y===x.DOLLY){if(e.noZoom===!0)return;p.set(a.clientX,a.clientY),q.subVectors(p,o),q.y>0?e.dollyIn():e.dollyOut(),o.copy(p)}else if(y===x.PAN){if(e.noPan===!0)return;k.set(a.clientX,a.clientY),l.subVectors(k,j),e.pan(l.x,l.y),j.copy(k)}e.update()}},this.onMouseUp=function(){e.enabled!==!1&&(document.removeEventListener("mousemove",e.onMouseMove,!1),document.removeEventListener("mouseup",e.onMouseUp,!1),e.dispatchEvent(D),y=x.NONE)},this.onMouseWheel=function(a){if(e.enabled!==!1&&e.noZoom!==!0){a.preventDefault(),a.stopPropagation();var b=0;void 0!==a.wheelDelta?b=a.wheelDelta:void 0!==a.detail&&(b=-a.detail),b>0?e.dollyOut():e.dollyIn(),e.update(),e.dispatchEvent(C),e.dispatchEvent(D)}},this.onKeyDown=function(a){if(e.enabled!==!1&&e.noKeys!==!0&&e.noPan!==!0)switch(a.keyCode){case e.keys.UP:e.pan(0,e.keyPanSpeed),e.update();break;case e.keys.BOTTOM:e.pan(0,-e.keyPanSpeed),e.update();break;case e.keys.LEFT:e.pan(e.keyPanSpeed,0),e.update();break;case e.keys.RIGHT:e.pan(-e.keyPanSpeed,0),e.update()}},this.touchstart=function(a){if(e.enabled!==!1){switch(a.touches.length){case 1:if(e.noRotate===!0)return;y=x.TOUCH_ROTATE,g.set(a.touches[0].pageX,a.touches[0].pageY);break;case 2:if(e.noZoom===!0)return;y=x.TOUCH_DOLLY;var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY,d=Math.sqrt(b*b+c*c);o.set(0,d);break;case 3:if(e.noPan===!0)return;y=x.TOUCH_PAN,j.set(a.touches[0].pageX,a.touches[0].pageY);break;default:y=x.NONE}e.dispatchEvent(C)}},this.touchmove=function(a){if(e.enabled!==!1){a.preventDefault(),a.stopPropagation();var b=e.domElement===document?e.domElement.body:e.domElement;switch(a.touches.length){case 1:if(e.noRotate===!0)return;if(y!==x.TOUCH_ROTATE)return;h.set(a.touches[0].pageX,a.touches[0].pageY),i.subVectors(h,g),e.rotateLeft(2*Math.PI*i.x/b.clientWidth*e.rotateSpeed),e.rotateUp(2*Math.PI*i.y/b.clientHeight*e.rotateSpeed),g.copy(h),e.update();break;case 2:if(e.noZoom===!0)return;if(y!==x.TOUCH_DOLLY)return;var c=a.touches[0].pageX-a.touches[1].pageX,d=a.touches[0].pageY-a.touches[1].pageY,f=Math.sqrt(c*c+d*d);p.set(0,f),q.subVectors(p,o),q.y>0?e.dollyOut():e.dollyIn(),o.copy(p),e.update();break;case 3:if(e.noPan===!0)return;if(y!==x.TOUCH_PAN)return;k.set(a.touches[0].pageX,a.touches[0].pageY),l.subVectors(k,j),e.pan(l.x,l.y),j.copy(k),e.update();break;default:y=x.NONE}}},this.touchend=function(){e.enabled!==!1&&(e.dispatchEvent(D),y=x.NONE)},this.onContextMenu=function(a){a.preventDefault()},this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),function(){var a=function(a){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.FrontSide,this.transparent=!0,this.setValues(a),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(a){a?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};a.prototype=Object.create(THREE.MeshBasicMaterial.prototype);var b=function(a){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(a),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(a){a?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};b.prototype=Object.create(THREE.LineBasicMaterial.prototype),THREE.TransformGizmo=function(){var a=this,b=!1,c=!1;this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var a=new THREE.PlaneGeometry(50,50,2,2),b=new THREE.MeshBasicMaterial({wireframe:!0});b.side=THREE.DoubleSide;var c={XY:new THREE.Mesh(a,b),YZ:new THREE.Mesh(a,b),XZ:new THREE.Mesh(a,b),XYZE:new THREE.Mesh(a,b)};this.activePlane=c.XYZE,c.YZ.rotation.set(0,Math.PI/2,0),c.XZ.rotation.set(-Math.PI/2,0,0);for(var d in c)c[d].name=d,this.planes.add(c[d]),this.planes[d]=c[d],c[d].visible=!1;var e=function(a,b){for(var c in a)for(d=a[c].length;d--;){var e=a[c][d][0],f=a[c][d][1],g=a[c][d][2];e.name=c,f&&e.position.set(f[0],f[1],f[2]),g&&e.rotation.set(g[0],g[1],g[2]),b.add(e)}};e(this.handleGizmos,this.handles),e(this.pickerGizmos,this.pickers),this.traverse(function(a){if(a instanceof THREE.Mesh){a.updateMatrix();var b=new THREE.Geometry;b.merge(a.geometry,a.matrix),a.geometry=b,a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1)}})},this.hide=function(){this.traverse(function(a){a.visible=!1})},this.show=function(){this.traverse(function(c){c.visible=!0,c.parent==a.pickers&&(c.visible=b),c.parent==a.planes&&(c.visible=!1)}),this.activePlane.visible=c},this.highlight=function(a){this.traverse(function(b){b.material&&b.material.highlight&&b.material.highlight(b.name==a?!0:!1)})}},THREE.TransformGizmo.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformGizmo.prototype.update=function(a,b){var c=new THREE.Vector3(0,0,0),d=new THREE.Vector3(0,1,0),e=new THREE.Matrix4;this.traverse(function(f){-1!=f.name.search("E")?f.quaternion.setFromRotationMatrix(e.lookAt(b,c,d)):(-1!=f.name.search("X")||-1!=f.name.search("Y")||-1!=f.name.search("Z"))&&f.quaternion.setFromEuler(a)})},THREE.TransformGizmoTranslate=function(){THREE.TransformGizmo.call(this);var c=new THREE.Geometry,d=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));d.position.y=.5,d.updateMatrix(),c.merge(d.geometry,d.matrix);var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0));var f=new THREE.Geometry;f.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,1,0));var g=new THREE.Geometry;g.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1)),this.handleGizmos={X:[[new THREE.Mesh(c,new a({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(e,new b({color:16711680}))]],Y:[[new THREE.Mesh(c,new a({color:65280})),[0,.5,0]],[new THREE.Line(f,new b({color:65280}))]],Z:[[new THREE.Mesh(c,new a({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(g,new b({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.1,0),new a({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneGeometry(.29,.29),new a({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneGeometry(.29,.29),new a({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneGeometry(.29,.29),new a({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:16711680,opacity:.25})),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:65280,opacity:.25})),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:255,opacity:.25})),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),new a({color:16777215,opacity:.25}))]],XY:[[new THREE.Mesh(new THREE.PlaneGeometry(.4,.4),new a({color:16776960,opacity:.25})),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneGeometry(.4,.4),new a({color:65535,opacity:.25})),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneGeometry(.4,.4),new a({color:16711935,opacity:.25})),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(a,b){var c=new THREE.Matrix4;b.applyMatrix4(c.getInverse(c.extractRotation(this.planes.XY.matrixWorld))),"X"==a&&(this.activePlane=this.planes.XY,Math.abs(b.y)>Math.abs(b.z)&&(this.activePlane=this.planes.XZ)),"Y"==a&&(this.activePlane=this.planes.XY,Math.abs(b.x)>Math.abs(b.z)&&(this.activePlane=this.planes.YZ)),"Z"==a&&(this.activePlane=this.planes.XZ,Math.abs(b.x)>Math.abs(b.y)&&(this.activePlane=this.planes.YZ)),"XYZ"==a&&(this.activePlane=this.planes.XYZE),"XY"==a&&(this.activePlane=this.planes.XY),"YZ"==a&&(this.activePlane=this.planes.YZ),"XZ"==a&&(this.activePlane=this.planes.XZ),this.hide(),this.show()},this.init()},THREE.TransformGizmoTranslate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoRotate=function(){THREE.TransformGizmo.call(this);var c=function(a,b,c){var d=new THREE.Geometry;c=c?c:1;for(var e=0;64*c>=e;++e)"x"==b&&d.vertices.push(new THREE.Vector3(0,Math.cos(e/32*Math.PI),Math.sin(e/32*Math.PI)).multiplyScalar(a)),"y"==b&&d.vertices.push(new THREE.Vector3(Math.cos(e/32*Math.PI),0,Math.sin(e/32*Math.PI)).multiplyScalar(a)),"z"==b&&d.vertices.push(new THREE.Vector3(Math.sin(e/32*Math.PI),Math.cos(e/32*Math.PI),0).multiplyScalar(a));return d};this.handleGizmos={X:[[new THREE.Line(new c(1,"x",.5),new b({color:16711680}))]],Y:[[new THREE.Line(new c(1,"y",.5),new b({color:65280}))]],Z:[[new THREE.Line(new c(1,"z",.5),new b({color:255}))]],E:[[new THREE.Line(new c(1.25,"z",1),new b({color:13421568}))]],XYZE:[[new THREE.Line(new c(1,"z",1),new b({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),new a({color:16711680,opacity:.25})),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),new a({color:65280,opacity:.25})),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),new a({color:255,opacity:.25})),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusGeometry(1.25,.12,2,24),new a({color:16776960,opacity:.25}))]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]},this.setActivePlane=function(a){"E"==a&&(this.activePlane=this.planes.XYZE),"X"==a&&(this.activePlane=this.planes.YZ),"Y"==a&&(this.activePlane=this.planes.XZ),"Z"==a&&(this.activePlane=this.planes.XY),this.hide(),this.show()},this.update=function(a,b){THREE.TransformGizmo.prototype.update.apply(this,arguments);var c=({handles:this.handles,pickers:this.pickers},new THREE.Matrix4),d=new THREE.Euler(0,0,1),e=new THREE.Quaternion,f=new THREE.Vector3(1,0,0),g=new THREE.Vector3(0,1,0),h=new THREE.Vector3(0,0,1),i=new THREE.Quaternion,j=new THREE.Quaternion,k=new THREE.Quaternion,l=b.clone();d.copy(this.planes.XY.rotation),e.setFromEuler(d),c.makeRotationFromQuaternion(e).getInverse(c),l.applyMatrix4(c),this.traverse(function(a){e.setFromEuler(d),"X"==a.name&&(i.setFromAxisAngle(f,Math.atan2(-l.y,l.z)),e.multiplyQuaternions(e,i),a.quaternion.copy(e)),"Y"==a.name&&(j.setFromAxisAngle(g,Math.atan2(l.x,l.z)),e.multiplyQuaternions(e,j),a.quaternion.copy(e)),"Z"==a.name&&(k.setFromAxisAngle(h,Math.atan2(l.y,l.x)),e.multiplyQuaternions(e,k),a.quaternion.copy(e))})},this.init()},THREE.TransformGizmoRotate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoScale=function(){THREE.TransformGizmo.call(this);var c=new THREE.Geometry,d=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));d.position.y=.5,d.updateMatrix(),c.merge(d.geometry,d.matrix);var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0));var f=new THREE.Geometry;f.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,1,0));var g=new THREE.Geometry;g.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1)),this.handleGizmos={X:[[new THREE.Mesh(c,new a({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(e,new b({color:16711680}))]],Y:[[new THREE.Mesh(c,new a({color:65280})),[0,.5,0]],[new THREE.Line(f,new b({color:65280}))]],Z:[[new THREE.Mesh(c,new a({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(g,new b({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125),new a({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:16711680,opacity:.25})),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:65280,opacity:.25})),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new a({color:255,opacity:.25})),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.4,.4,.4),new a({color:16777215,opacity:.25}))]]},this.setActivePlane=function(a,b){var c=new THREE.Matrix4;b.applyMatrix4(c.getInverse(c.extractRotation(this.planes.XY.matrixWorld))),"X"==a&&(this.activePlane=this.planes.XY,Math.abs(b.y)>Math.abs(b.z)&&(this.activePlane=this.planes.XZ)),"Y"==a&&(this.activePlane=this.planes.XY,Math.abs(b.x)>Math.abs(b.z)&&(this.activePlane=this.planes.YZ)),"Z"==a&&(this.activePlane=this.planes.XZ,Math.abs(b.x)>Math.abs(b.y)&&(this.activePlane=this.planes.YZ)),"XYZ"==a&&(this.activePlane=this.planes.XYZE),this.hide(),this.show()},this.init()},THREE.TransformGizmoScale.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformControls=function(a,b){function c(c,d){var e=b.getBoundingClientRect(),f=(c.clientX-e.left)/e.width,g=(c.clientY-e.top)/e.height;j.set(2*f-1,2*-g+1,.5),i.unprojectVector(j,a),h.set(K,j.sub(K).normalize());var k=h.intersectObjects(d,!0);return k[0]?k[0]:!1}THREE.Object3D.call(this),b=void 0!==b?b:document,this.gizmo={},this.gizmo.translate=new THREE.TransformGizmoTranslate,this.gizmo.rotate=new THREE.TransformGizmoRotate,this.gizmo.scale=new THREE.TransformGizmoScale,this.add(this.gizmo.translate),this.add(this.gizmo.rotate),this.add(this.gizmo.scale),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.object=void 0,this.snap=null,this.space="world",this.size=1,this.axis=null;var d=this,e=!1,f="translate",g={type:"change"},h=new THREE.Raycaster,i=new THREE.Projector,j=new THREE.Vector3,k=new THREE.Vector3,l=new THREE.Vector3,m=new THREE.Vector3,n=new THREE.Vector3,o=1,p=new THREE.Matrix4,q=new THREE.Vector3,r=new THREE.Matrix4,s=new THREE.Vector3,t=new THREE.Quaternion,u=new THREE.Vector3(1,0,0),v=new THREE.Vector3(0,1,0),w=new THREE.Vector3(0,0,1),x=new THREE.Quaternion,y=new THREE.Quaternion,z=new THREE.Quaternion,A=new THREE.Quaternion,B=new THREE.Quaternion,C=new THREE.Vector3,D=new THREE.Vector3,E=new THREE.Matrix4,F=new THREE.Matrix4,G=new THREE.Vector3,H=new THREE.Vector3,I=new THREE.Euler,J=new THREE.Matrix4,K=new THREE.Vector3,L=new THREE.Euler;this.attach=function(a){d.object=a,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[f].show(),d.update()},this.detach=function(){d.object=void 0,this.axis=void 0,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide()},this.disable=function(){d.object=void 0,this.axis=void 0},this.setMode=function(a){f=a?a:f,"scale"==f&&(d.space="local"),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[f].show(),this.update(),d.dispatchEvent(g)},this.setSnap=function(a){d.snap=a},this.setSize=function(a){d.size=a,this.update(),d.dispatchEvent(g)},this.setSpace=function(a){d.space=a,this.update(),d.dispatchEvent(g)},this.update=function(){void 0!==d.object&&(d.object.updateMatrixWorld(),H.setFromMatrixPosition(d.object.matrixWorld),I.setFromRotationMatrix(r.extractRotation(d.object.matrixWorld)),a.updateMatrixWorld(),K.setFromMatrixPosition(a.matrixWorld),L.setFromRotationMatrix(r.extractRotation(a.matrixWorld)),o=H.distanceTo(K)/6*d.size,this.position.copy(H),this.scale.set(o,o,o),q.copy(K).sub(H).normalize(),"local"==d.space?this.gizmo[f].update(I,q):"world"==d.space&&this.gizmo[f].update(new THREE.Euler,q),this.gizmo[f].highlight(d.axis))},this.onPointerHover=function(a){if(void 0!==d.object&&e!==!0){a.preventDefault();var b=a.changedTouches?a.changedTouches[0]:a,h=c(b,d.gizmo[f].pickers.children);h?(d.axis=h.object.name,d.update(),d.dispatchEvent(g)):null!==d.axis&&(d.axis=null,d.update(),d.dispatchEvent(g))}},this.onPointerDown=function(a){if(void 0!==d.object&&e!==!0){a.preventDefault(),a.stopPropagation();var b=a.changedTouches?a.changedTouches[0]:a;if(0===b.button||void 0===b.button){var g=c(b,d.gizmo[f].pickers.children);if(g){d.axis=g.object.name,d.update(),q.copy(K).sub(H).normalize(),d.gizmo[f].setActivePlane(d.axis,q);var h=c(b,[d.gizmo[f].activePlane]);C.copy(d.object.position),D.copy(d.object.scale),E.extractRotation(d.object.matrix),J.extractRotation(d.object.matrixWorld),F.extractRotation(d.object.parent.matrixWorld),G.setFromMatrixScale(r.getInverse(d.object.parent.matrixWorld)),l.copy(h.point)}}e=!0}},this.onPointerMove=function(a){if(void 0!==d.object&&null!==d.axis&&e!==!1){a.preventDefault(),a.stopPropagation();var b=a.changedTouches?a.changedTouches[0]:a,h=c(b,[d.gizmo[f].activePlane]);k.copy(h.point),"translate"==f?(k.sub(l),k.multiply(G),"local"==d.space&&(k.applyMatrix4(r.getInverse(J)),-1==d.axis.search("X")&&(k.x=0),-1==d.axis.search("Y")&&(k.y=0),-1==d.axis.search("Z")&&(k.z=0),k.applyMatrix4(E),d.object.position.copy(C),d.object.position.add(k)),("world"==d.space||-1!=d.axis.search("XYZ"))&&(-1==d.axis.search("X")&&(k.x=0),-1==d.axis.search("Y")&&(k.y=0),-1==d.axis.search("Z")&&(k.z=0),k.applyMatrix4(r.getInverse(F)),d.object.position.copy(C),d.object.position.add(k)),null!==d.snap&&(-1!=d.axis.search("X")&&(d.object.position.x=Math.round(d.object.position.x/d.snap)*d.snap),-1!=d.axis.search("Y")&&(d.object.position.y=Math.round(d.object.position.y/d.snap)*d.snap),-1!=d.axis.search("Z")&&(d.object.position.z=Math.round(d.object.position.z/d.snap)*d.snap))):"scale"==f?(k.sub(l),k.multiply(G),"local"==d.space&&("XYZ"==d.axis?(o=1+k.y/50,d.object.scale.x=D.x*o,d.object.scale.y=D.y*o,d.object.scale.z=D.z*o):(k.applyMatrix4(r.getInverse(J)),"X"==d.axis&&(d.object.scale.x=D.x*(1+k.x/50)),"Y"==d.axis&&(d.object.scale.y=D.y*(1+k.y/50)),"Z"==d.axis&&(d.object.scale.z=D.z*(1+k.z/50))))):"rotate"==f&&(k.sub(H),k.multiply(G),s.copy(l).sub(H),s.multiply(G),"E"==d.axis?(k.applyMatrix4(r.getInverse(p)),s.applyMatrix4(r.getInverse(p)),m.set(Math.atan2(k.z,k.y),Math.atan2(k.x,k.z),Math.atan2(k.y,k.x)),n.set(Math.atan2(s.z,s.y),Math.atan2(s.x,s.z),Math.atan2(s.y,s.x)),t.setFromRotationMatrix(r.getInverse(F)),B.setFromAxisAngle(q,m.z-n.z),x.setFromRotationMatrix(J),t.multiplyQuaternions(t,B),t.multiplyQuaternions(t,x),d.object.quaternion.copy(t)):"XYZE"==d.axis?(B.setFromEuler(k.clone().cross(s).normalize()),t.setFromRotationMatrix(r.getInverse(F)),y.setFromAxisAngle(B,-k.clone().angleTo(s)),x.setFromRotationMatrix(J),t.multiplyQuaternions(t,y),t.multiplyQuaternions(t,x),d.object.quaternion.copy(t)):"local"==d.space?(k.applyMatrix4(r.getInverse(J)),s.applyMatrix4(r.getInverse(J)),m.set(Math.atan2(k.z,k.y),Math.atan2(k.x,k.z),Math.atan2(k.y,k.x)),n.set(Math.atan2(s.z,s.y),Math.atan2(s.x,s.z),Math.atan2(s.y,s.x)),x.setFromRotationMatrix(E),y.setFromAxisAngle(u,m.x-n.x),z.setFromAxisAngle(v,m.y-n.y),A.setFromAxisAngle(w,m.z-n.z),"X"==d.axis&&x.multiplyQuaternions(x,y),"Y"==d.axis&&x.multiplyQuaternions(x,z),"Z"==d.axis&&x.multiplyQuaternions(x,A),d.object.quaternion.copy(x)):"world"==d.space&&(m.set(Math.atan2(k.z,k.y),Math.atan2(k.x,k.z),Math.atan2(k.y,k.x)),n.set(Math.atan2(s.z,s.y),Math.atan2(s.x,s.z),Math.atan2(s.y,s.x)),t.setFromRotationMatrix(r.getInverse(F)),y.setFromAxisAngle(u,m.x-n.x),z.setFromAxisAngle(v,m.y-n.y),A.setFromAxisAngle(w,m.z-n.z),x.setFromRotationMatrix(J),"X"==d.axis&&t.multiplyQuaternions(t,y),"Y"==d.axis&&t.multiplyQuaternions(t,z),"Z"==d.axis&&t.multiplyQuaternions(t,A),t.multiplyQuaternions(t,x),d.object.quaternion.copy(t))),d.update(),d.dispatchEvent(g)}},this.onPointerUp=function(a){e=!1,d.onPointerHover(a)},this.isDragging=function(){return!(void 0===d.object||null===d.axis||e===!1)},this.eventIntersectsControl=function(a,b){var g=b.changedTouches?b.changedTouches[0]:b,h={onPointerHover:function(){if(void 0===d.object||e===!0)return!1;var a=c(g,d.gizmo[f].pickers.children);return a},onPointerDown:function(){if(void 0===d.object||e===!0)return!1;if(0===g.button||void 0===g.button){var a=c(g,d.gizmo[f].pickers.children);if(a){d.axis=a.object.name,d.update(),q.copy(K).sub(H).normalize(),d.gizmo[f].setActivePlane(d.axis,q);var b=c(g,[d.gizmo[f].activePlane]);return b}return!1}return!1},onPointerMove:function(){if(void 0===d.object||null===d.axis||e===!1)return!1;var a=c(g,[d.gizmo[f].activePlane]);return a}};return h[a]&&h[a](b)}},THREE.TransformControls.prototype=Object.create(THREE.Object3D.prototype)}();{var d=function(a,b){var c=function(){return a.apply(this,b)};return c.prototype=a.prototype,new c},e=function(a){return a&&a.charAt(0).toUpperCase()+a.slice(1)},f=(b.Drawable=c.Model.extend({defaults:{texture:"/img/crate.gif",geometryType:"BoxGeometry",geometryParams:[200,200,200],matrix:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},_mesh:void 0,_texture:void 0,_material:void 0,_geometry:void 0,initDrawable:function(){var a=this,b=function(){void 0!==a.collection&&a.collection.trigger("drawable:loaded",a),a.trigger("drawable:loaded",a),a.on("change:matrix",function(){a.updateMesh()}),a.updateMesh()};THREE.hasOwnProperty(this.get("geometryType"))?(this._texture=THREE.ImageUtils.loadTexture(this.get("texture"),new THREE.UVMapping,b),this._geometry=d(THREE[this.get("geometryType")],this.get("geometryParams")),this._material=new THREE.MeshLambertMaterial({map:this._texture}),this._mesh=new THREE.Mesh(this._geometry,this._material)):console.warn("Drawable: no compatible geometry type")},updateMesh:function(){this._mesh.matrix.set.apply(this._mesh.matrix,this.get("matrix")),this._mesh.matrix.decompose(this._mesh.position,this._mesh.quaternion,this._mesh.scale)},getMesh:function(){return this._mesh},initialize:function(){this.initDrawable()}}),b.OrbitControl=c.Model.extend({_control:void 0,initializeControl:function(){this._control=new THREE.OrbitControls(this.renderer.camera),this._control.damping=.1},getControl:function(){return this._control},disable:function(){this._control.enabled=!1},enable:function(){this._control.enabled=!0},isEnabled:function(){return this._control.enabled},dispatchDOMEvent:function(a){var b={contextmenu:"onContextMenu",mousedown:"onMouseDown",mousewheel:"onMouseWheel",DOMMouseScroll:"onMouseWheel",touchstart:"touchstart",touchend:"touchend",touchmove:"touchmove",keydown:"onKeyDown"};b[a.type]&&_.isFunction(this._control[b[a.type]])&&this._control[b[a.type]].call(this._control,a)},renderer:void 0,initialize:function(a){this.renderer=a.renderer,this.initializeControl()}})),g=b.TransformControl=c.Model.extend({defaults:{attachedDrawable:void 0,mode:"translate",space:"local"},_control:void 0,initializeControl:function(){var a=this;this._control=new THREE.TransformControls(this.renderer.camera,this.renderer.renderer.domElement),this._control.addEventListener("change",function(){var b=a.get("attachedDrawable"),c=b.getMesh().matrix.elements,d=Array.prototype.slice.call(c),e=d,f=[e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]];_.isEqual(b.get("matrix"),f)||(b.set("matrix",f),b.save({}))}),a.renderer.scene.add(a._control)},getControl:function(){return this._control},getAttachedDrawable:function(){return this.get("attachedDrawable")},attachDrawable:function(a){this.get("attachedDrawable")!==a&&(this.set("attachedDrawable",a),this._control.attach(a.getMesh()))},detachDrawable:function(a){a=a||this.get("attachedDrawable"),this.set("attachedDrawable",void 0),a?this._control.disable(a.getMesh()):console.log("TransformControl: can't detach nonexistant drawable")},hasAttachedDrawable:function(){return this.get("attachedDrawable")},controlEventMap:{mousedown:"onPointerDown",touchstart:"onPointerDown",mousemove:["onPointerHover","onPointerMove"],touchmove:["onPointerHover","onPointerMove"],mouseup:"onPointerUp",mouseout:"onPointerUp",touchend:"onPointerUp",touchcancel:"onPointerUp",touchleave:"onPointerUp"},dispatchDOMEvent:function(a){var b=this,c=this.controlEventMap[a.type],d=_.isArray(c)?c:[c];d.forEach(function(c){b._control[c]&&b._control[c].call(b._control,a)})},intersectsControl:function(a){var b,c=this,d=this.controlEventMap[a.type],e=_.isArray(d)?d:[d];return e.forEach(function(d,e){var f=c._control.eventIntersectsControl(d,a);b=0==e?f:b||f}),b},isDragging:function(){return this._control.isDragging()},renderer:void 0,initialize:function(a){this.renderer=a.renderer,this.initializeControl(),this.on("change:mode",function(){this._control.setMode(this.get("mode"))}),this.on("change:space",function(){this._control.setSpace(this.get("space"))})}});b.ThreeJSRenderer=Marionette.ItemView.extend({template:_.template("<div></div>"),collectionEvents:{remove:function(a){this.removeDrawable(a)},"drawable:loaded":function(a){this.addDrawable(a)}},_transformControlDragging:!1,onPointerDown:function(a){this.dispatchDOMEventToControls(a)},onPointerHover:function(a){this.dispatchDOMEventToControls(a)},onPointerMove:function(a){this.dispatchDOMEventToControls(a)},onPointerUp:function(a){if(this.dispatchDOMEventToControls(a),!this._transformControlDragging){var b=[];this.collection.forEach(function(a){var c=a.getMesh();if(c){var d=[];c.traverse(function(a){a&&d.push(a)}),d.forEach(function(c){b.push({drawable:a,mesh:c})})}}),this._raycast({event:a,callback:function(a){var c;a[0]&&(c=_.findWhere(b,{mesh:a[0].object}).drawable),c&&this.transformControl.attachDrawable(c)}})}},onMouseWheel:function(a){this.dispatchDOMEventToControls(a)},onKeyDown:function(a){this.dispatchDOMEventToControls(a)},onContextMenu:function(a){this.dispatchDOMEventToControls(a)},getWidth:function(){return window.innerWidth-this.$el.find("div").offset().left-1},getHeight:function(){return window.innerHeight-this.$el.find("div").offset().top-5.25},camera:void 0,scene:void 0,renderer:void 0,setupRenderer:function(){this.renderer=new THREE.WebGLRenderer({precision:"highp",antialias:!0}),this.renderer.sortObjects=!1,this.renderer.setSize(this.getWidth(),this.getHeight()),this.renderer.setClearColor(11184810);var a=this,b=function(){a.$el.find("div").append(a.renderer.domElement)};b(),this.on("render",b)},setupCamera:function(){this.camera=new THREE.PerspectiveCamera(70,this.getWidth()/this.getHeight(),.01,1e4),this.camera.position.set(1e3,500,1e3),this.camera.lookAt(new THREE.Vector3(0,200,0))},setupScene:function(){this.scene=new THREE.Scene;var a=new THREE.GridHelper(1e3,100);a.setColors(4473924,8947848),this.scene.add(a);var b=new THREE.HemisphereLight(16777215,6576451);b.position.set(0,50,0),this.scene.add(b)},addDrawable:function(a){console.log("ThreeJSRenderer: add drawable");var b=a.getMesh();b&&this.scene.add(b)},removeDrawable:function(a){console.log("ThreeJSRenderer: remove drawable");var b=a.getMesh();b&&this.scene.remove(b)},onWindowResize:function(){this.camera.aspect=this.getWidth()/this.getHeight(),this.camera.updateProjectionMatrix(),this.renderer.setSize(this.getWidth(),this.getHeight())},startWebGLRendering:function(){var a=this,b=function(){a.transformControl.getControl().update(),a.renderer.render(a.scene,a.camera)},c=function(){requestAnimationFrame(c),b()};c()},pointerVector:new THREE.Vector3,rayCaster:new THREE.Raycaster,projector:new THREE.Projector,_raycast:function(a){var b=a.event,c=a.callback;if(c){var d=[];a.meshes?d=a.meshes:this.collection.forEach(function(a){a.getMesh()&&d.push(a.getMesh())});var e=this.renderer.domElement.getBoundingClientRect(),f=(b.clientX-e.left)/e.width,g=(b.clientY-e.top)/e.height;this.pointerVector.set(2*f-1,2*-g+1,.5),this.projector.unprojectVector(this.pointerVector,this.camera),this.rayCaster.set(this.camera.position,this.pointerVector.sub(this.camera.position).normalize());var h=this.rayCaster.intersectObjects(d,!0);c.call(this,h)}},transformControl:void 0,orbitControl:void 0,setupTransformControl:function(){this.transformControl||(this.transformControl=new g({renderer:this}),this.trigger("transformcontrols:create",this.transformControl))},disableTransformControl:function(){this.transformControl&&this.transformControl.hasAttachedDrawable()&&this.transformControl.detachDrawable()},setupOrbitControl:function(){this.orbitControl?this.orbitControl.enable():this.orbitControl=new f({renderer:this})},disableOrbitControl:function(){this.orbitControl&&this.orbitControl.isEnabled()&&this.orbitControl.disable()},setupPointerEvents:function(){var a=this.renderer.domElement,b={mousedown:"onPointerDown",touchstart:"onPointerDown",mousemove:["onPointerHover","onPointerMove"],touchmove:["onPointerHover","onPointerMove"],mouseup:"onPointerUp",mouseout:"onPointerUp",touchend:"onPointerUp",touchcancel:"onPointerUp",touchleave:"onPointerUp",mousewheel:"onMouseWheel",DOMMouseScroll:"onMouseWheel",keydown:"onKeyDown",contextmenu:"onContextMenu"},c=this;
_.forEach(b,function(b,d){var e=_.isArray(b)?b:[b];e.forEach(function(b){a.addEventListener(d,c[b].bind(c),!1)})})},dispatchDOMEventToControls:function(a){this.transformControl.intersectsControl(a)||this.orbitControl.dispatchDOMEvent(a),this.transformControl?(this._transformControlDragging=this.transformControl.isDragging(),this.transformControl.dispatchDOMEvent(a)):this._transformControlDragging=!1},initialize:function(){this.once("show",function(){this.setupRenderer(),this.setupCamera(),this.setupScene(),this.setupPointerEvents(),this.setupTransformControl(),this.setupOrbitControl(),this.collection.fetch();var a=this;window.addEventListener("resize",function(){a.onWindowResize()},!1),a.startWebGLRendering(),a.render()})}}),b.TransformControlMode=Marionette.ItemView.extend({templateHelpers:function(){return{transformControlSpace:this.transformControl&&e(this.transformControl.get("space"))}},events:{"click #translate-mode":function(){this.transformControl.set("mode","translate")},"click #rotate-mode":function(){this.transformControl.set("mode","rotate")},"click #scale-mode":function(){this.transformControl.set("mode","scale")},"click #toggle-space":function(){var a="local"==this.transformControl.get("space")?"world":"local";this.transformControl.set("space",a),this.render()}},transformControl:void 0,initialize:function(a){this.transformControl=a.transformControl}})}return b});